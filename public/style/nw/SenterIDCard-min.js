var FFI=require("ffi");var fs=require("fs");var ref=require("ref");var Struct=require("ref-struct");var ArrayType=require("ref-array");var iconv=require("iconv-lite");var T_Struct=new Struct({Name:new ArrayType("char",32),Sex:new ArrayType("char",4),Nation:new ArrayType("char",10),Birthday:new ArrayType("char",18),Address:new ArrayType("char",72),IDCardNo:new ArrayType("char",38),GrantDept:new ArrayType("char",32),ValidBegin:new ArrayType("char",18),ValidEnd:new ArrayType("char",18),AppendMsg:new ArrayType("char",72),sexCode:new ArrayType("char",4),nationCode:new ArrayType("char",4),PhotoFileName:new ArrayType("char",255),SAMID:new ArrayType("char",128),imgBase64:new ArrayType("char",8e3),WltBuffer:new ArrayType("uchar",1024)});var IDCardInfoPtr=ref.refType(T_Struct);var cardInfo=new T_Struct;var cvrDll={readCard:function(){fs.unlink(process.cwd()+"/lib/senter/zp.wlt");var r;FFI.Library(process.cwd()+"/lib/senter/sdtapi.dll");var e=new FFI.Library(process.cwd()+"/lib/senter/IDCardReader.dll",{FindCard:["int",[]],GetIDCardInfo:["int",[IDCardInfoPtr]]});var a=e.FindCard();if(a===11){var n=e.GetIDCardInfo(cardInfo.ref());var d=fs.readFileSync(process.cwd()+"/lib/senter/zp.wlt").toString("hex");if(n===0){r={name:this.Decode(cardInfo.Name),gender:this.Decode(cardInfo.Sex),genderCode:this.Decode(cardInfo.sexCode),nation:this.Decode(cardInfo.Nation),nationCode:this.Decode(cardInfo.nationCode),birthday:this.Decode(cardInfo.Birthday),address:this.Decode(cardInfo.Address),idCode:this.Decode(cardInfo.IDCardNo),dept:this.Decode(cardInfo.GrantDept),validityStart:this.Decode(cardInfo.ValidBegin),validityEnd:this.Decode(cardInfo.ValidEnd),SAMID:this.Decode(cardInfo.SAMID),code:1,zp:this.Decode(cardInfo.imgBase64),wlt:d,message:this.returnMsg(n)};return r}else{console.log("操作失败: "+n+" msg = "+this.returnMsg(n));return{code:0-n,message:this.returnMsg(n)}}}else{console.log("操作失败: "+a+" msg = "+this.returnMsg(a));return{code:0-a,message:this.returnMsg(a)}}},Decode:function(r){return iconv.decode(new Buffer(r),"GB18030")},returnMsg:function(r){r=r>11?12:r;var e=["操作成功","没有找到读卡器","开启读卡器失败","关闭读卡器失败","识别不到身份证","识别到身份证，但读取身份证信息失败","读取身份证信息成功，但回写身份证图片到本地失败","保存bmp文件出错","保存jpg文件出错","SamID获取失败","寻卡失败","寻卡成功","其他错误"];return e[r]}};